\section{Purpose}
\label{sec:purpose}
Anysphere is a metadata-private messaging (MPM) system. In Anysphere's whitepaper \cite[Section 3]{whitepaper}, we describe Anysphere's core protocol at a high level. We write this document to rigorously show that Anysphere's core protocol satisfies the metadata privacy we promise. 
% Most private messaging systems deployed in practice, such as Signal, lack formal security definitions and proofs, which has led to vulnerabilities being discovered later \cite{wichelmann2021help}. % not a good example. just an edge case. we have a lot of edge cases here that we are ignoring (eg trust establishment)
\arvid{bash existing systems (eg signal) for not having security definitions. problem is that signal was proven to be secure later, so it is actually not a good example.}

Existing security proof on MPM (such as \cite{corrigan2010dissent, corrigan2015riposte, angel2016unobservable, ahmad2021addra}) have shown the privacy of a private information retrieval(PIR) system where users can deposit and retrieve information without revealing metadata to the server. We find these proofs unsatisfying for several reasons.
\begin{itemize}
    \item The security of the PIR system does not guarantee the security of the messaging system as a whole. A well-known example illustrating this is the Compromised Friend(CF) attack proposed by Angel, Lazar and Tzialla(\cite{angel2018cf}). They show that if an honest user makes friend with a malicious user, then the metadata of conversations between honest users might be compromised even with a secure PIR system. To our knowledge, no proofs exist that show immunity against CF attacks\footnote{Pung's security proof \cite[Appendix C]{angel2018thesis} did establish the security of the messaging system, but under the strong assumption that honest users only ever talk to honest users.}. In fact, two similar CF attacks, described in \cref{subsec:security-vulnerable}, are found in our system while we write the proof. 
    
    \item Our system uses Addra(\cite{ahmad2021addra}) as the PIR system. Addra is originally designed for users to hold exactly one conversation at a time. In our application, clients may hold many different conversations at the same time. We need to ensure that our adaptation does not introduce new vulnerabilities.
    
    \item Addra, and other MPM systems like Pung(\cite{angel2016unobservable}), assume that clients run in synchronous round, and each client sends exactly one message to the server each round. As clients have different level of resources, running synchronous rounds is not economical. For example, big companies might wish rounds run faster to receive timely updates, while individual clients might not want to participate in each round to preserve bandwidth. Anysphere uses asynchronous rounds where each client can transmit on a different schedule. We need to justify the security of this decision.
    
    \item The above mentioned MPM systems also lack a mechanism to detect and retransmit lost or shuffled packages. To address this issue, We introduce an ACK mechanism in Anysphere. As we will see below, justifying the security of this mechanism is far from trivial.
\end{itemize}

Our paper is organized as follows. In \cref{sec:general-defn}, we present a formal security definition of what it means for a whole messaging system to be correct and secure. Our definition takes into consideration both asynchronous rounds and user inputs. A system satisfying our definition guarantees metadata privacy against a malicious server and an arbitrary set of clients, including potential CF attacks.

In \cref{sec:asphr-defn}, we describe the Anysphere core protocol in pseudocode. We also define exact security requirement on the cryptographic packages we use. In particular, we introduce a novel security definition that we require of our symmetric key cryptosystem. In \cref{sec:proofs} we prove that the protocol defined in \cref{sec:asphr-defn} satisfies the security definition in \cref{sec:general-defn}.

\todo{Currently, we assume all clients have registered before execution. We also do not handle trust establishment.}

\todo{Also, CF attack is a huge problem! What should we do about it?}

\section{Conventions}
Double column makes the paper easier to read, but prevents me from writing very long formulas. Therefore, I am introducing a few conventions to avoid introducing long formulas.
\begin{itemize}
    \item When we write $f(\cdot)$, the dot might hide several variables.
    
    \item Given an oracle $O(x, \cdot)$ and a series $\{x_i\}$, define $O(\{x_i\}, \cdot)$ as the oracle whose input takes an extra argument $j$ and outputs $O(\{x_i\}_i, j, \arg) = O(x_j, \arg)$.

    \item When we say two experiments are indistinguishable, we mean the view of the adversary in the two experiments are indistinguishable. The view of the adversary consists of all inputs, outputs, and internal randomness of the adversary.
    
    \item When machines ``return" in a method, they do not execute any subsequent commands and exit the method immediately.
\end{itemize}

\sualeh{we need }